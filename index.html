<!DOCTYPE html>
<html>
  <head>
    <title>ko-griddle-engine - Demo page</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script type="text/javascript" src="lib/knockout-3.4.0.js"></script>
    <script type="text/javascript" src="js/ko-binding.js"></script>

    <!-- Simple Grid template -->
            <script type="text/template" id="grid-tmpl">
                <table align="center" cellSpacing="0" cellPadding="0" style="overflow: hidden;">
                    <tbody ko-template="{ name: 'grid-row-tmpl', foreach: rows }">
                    </tbody>
                </table>
                <br/>
                <div style="border: 1px solid grey; background: #eee;">
                    Selected:
                    <br/>
                    <image ko-attr="{ src: imageSource(selectedTile()) }" style="vertical-align: middle; zoom: 2.0;" />
                    <select ko-foreach="tiles" ko-value="selectedTile">
                        <option ko-attr="{ value: $data }" ko-text="$data"></option>
                    </select>
                    <!-- <select ko-value="zoom">
                        <option>0.3</option>
                        <option>0.6</option>
                        <option>0.8</option>
                        <option selected="selected">1.0</option>
                        <option>1.5</option>
                        <option>2.0</option>
                        <option>2.5</option>
                    </select>-->
                    <select ko-value="zoom">
                        <option>-30deg</option>
                        <option>-20deg</option>
                        <option>-10deg</option>
                        <option selected="selected">0deg</option>
                        <option>10deg</option>
                        <option>20deg</option>
                        <option>30deg</option>
                    </select>

                </div>
                <div ko-template="{ name: 'palette-tmpl', data: $data }"  style="border: 1px solid grey; background: #ddf;">
                </div>
            </script>
            <script type="text/template" id="palette-tmpl">
                <br/>
                Palette:
                <br/>
                <div ko-foreach="{ data: tiles, as: 'tile' }">
                    <span ko-click="$component.clickPaletteItem">
                        <image ko-attr="{ src: $component.imageSource(tile) }"/>
                    </span>
                </div>
            </script>
            <script type="text/template" id="grid-row-tmpl">
                <tr ko-template="{ name: $component.cellType, foreach: cells, as: 'cellData' }">
                </tr>
            </script>
            <script type="text/template" id="grid-cell-tmpl">
                <td ko-html="cellData" ko-attr="{ 'data-col': $index }">
                </td>
            </script>
            <script type="text/template" id="image-cell-tmpl">
                <td ko-click="function() { $component.clickCell($parentContext.$index, $index); }">
                    <img ko-attr="{src: $component.imageSource(cellData) }" style="width: 100%; animation: roll 2.0s infinite linear;" />
                </td>
            </script>
            <!-- Simple grid Component -->
    	    <script type="text/javascript">
    	        var GridVM = function(params) {
    	            var self = this;

    	            // If there is a reference observable parameter, assign self to it
    	            if (params.reference)
    	                params.reference(self);

    	            self.rows = ko.observableArray([]);
    	            self.cellType = ko.observable(params.cellType || 'grid-cell-tmpl');
    	            self.selectedTile = ko.observable('');
    	            self.zoom = ko.observable(1.0);
    	            self.appendRow = function(cellList) {
    	                self.rows.push({
    	                    cells: ko.observableArray(cellList)
    	                });
    	            };

    	            self.getGridData = function() {
    	                var rowData = ko.toJS(engine.gridComponent().rows);
    	                for (var i = 0; i < rowData.length; i++) {
    	                    var row = rowData[i];

    	                    var cells = row.cells;
    	                    rowData[i] = cells;
    	                }
    	                return rowData;
    	            };
    	            self.setGridData = function(data) {
    	                self.rows([]); // clear rows
    	                for (var i = 0; i < data.length; i++) {
    	                    var row = { cells: ko.observableArray(data[i]) };

    	                    self.rows.push(row);
    	                }
    	            };
    	            self.setCell = function(row, col, data) {
    	                if (row < 0 || self.rows().length <= row)
    	                    return;
    	                var cellList = self.rows()[row].cells();
    	                if (col < 0 || cellList.length <= col)
    	                    return;
    	                cellList[col] = data;
    	                self.rows()[row].cells(cellList); //update observable cell list
    	            };

    	            $(params.rows || []).each(function() {
    	                var cellList = this;
    	                self.appendRow(cellList);
    	            });

    	            self.tiles = ko.observableArray([1,2,3,4,5,6,7,8,9,10,"DEFAULT"]);
    	            self.tileLookup = {
    	                "1": "media/hazy-tile-1.png",
    	                "2": "media/hazy-tile-2.png",
    	                "3": "media/hazy-tile-3.png",
    	                "4": "media/hazy-tile-4.png",
    	                "5": "media/hazy-tile-5.png",
    	                "6": "media/hazy-tile-6.png",
                      "7": "media/hazy-tile-7.png",
                      "8": "media/hazy-tile-8.png",
                      "9": "media/hazy-tile-9.png",
                      "10": "media/hazy-tile-10.png",
    	                "DEFAULT": "media/hazy-tile-empty.png"
    	            };

    	            // Return an image source based on cell data
    	            self.imageSource = function(cellData) {
    	                if (cellData in self.tileLookup)
    	                    return self.tileLookup[cellData];
    	                return self.tileLookup["DEFAULT"];
    	            };

    	            self.clickCell = function(row, col) {
    	                self.setCell(koVal(row), koVal(col), self.selectedTile());
    	            };

    	            self.clickPaletteItem = function(item) {
    	                self.selectedTile(item);
    	            };

    	        };

    	        ko.components.register('grid-cmp', {
    	            viewModel: GridVM,
    	            template: { element: 'grid-tmpl' }
    	        });

    	        var EngineVM = function(data) {
    	            var self = this;

                  self.gridComponent = ko.observable('');
                  self.frame = ko.observable(0);
                  self.frameRate = ko.observable(data.frameRate || 500);
    	            self.timer = null;
    	            self.isActive = ko.observable(false);
    	            self.afterAdvance = data.afterAdvance || function() {};

    	            self.start = function() {
    	                if (self.timer == null)
    	                    self.timer = setInterval(self.advance, self.frameRate());
    	                self.isActive(true);
    	            };
    	            self.stop = function() {
    	                if (self.timer != null) {
    	                    clearInterval(self.timer);
    	                    self.timer = null;
    	                }
    	                self.isActive(false);
    	            };
    	            self.toggleAdvance = function() {
    	                if (self.timer == null)
    	                    self.start();
    	                else
    	                    self.stop();
    	            };
                  // Attach event to frameRate changes
    	            self.frameRate.subscribe(function() {
    	                // Restart timer on frame rate change
                      self.stop();
    	                self.frameRate(); // Create a dependency on frame rate to trigger logic
    	                self.start();
    	            });
    	            self.advance = function() {
    	                self.frame(self.frame() + 1);
    	                self.afterAdvance(self);
    	            };

                  self.seconds = ko.computed(function() {
                      var total = self.frame() * self.frameRate();
                      var seconds = Math.floor((total / 1000) % 60);
                      seconds = '0' + seconds.toString();
                      seconds = seconds.substr(seconds.length - 2, 2);
                      return seconds;
                  }, self);
                  self.minutes = ko.computed(function() {
                      var total = self.frame() * self.frameRate();
                      var min = Math.floor((total / (1000 * 60)) % 60);
                      min = '0' + min.toString();
                      min = min.substr(min.length - 2, 2);
                      return min;
                  }, self);

    	        };
    	    </script>

    <style>


    @keyframes roll {
      0% {
        transform: rotate(0) scale(1.0);
      }
      50% {
        transform: rotate(180deg) scale(0.8);
      }
      100% {
        transform: rotate(360deg) scale(1.0);
      }
    }

      body { margin: 20px; solid #888; text-align: center; }
      #sandbox { width: 1000px; margin-left: auto; margin-right: auto; }
      .grid-well { background-color: #666; box-shadow: inset 0 0 50px rgba(0,0,0,0.75); margin-left: auto; margin-right: auto; }
      .muted { color: #888; }
    </style>
  </head>
  <body>
    <h1><em>ko-griddle-engine</em> - Demo page</h1>

    <div id="sandbox">
      <h5><span class="muted">Frame</span> <span ko-text="frame"></span> <span class="muted">Time</span> <span ko-text="minutes"></span>:<span ko-text="seconds"></span></h1>
      <button ko-text="(isActive() ? 'Stop' : 'Start')" ko-click="toggleAdvance"></button>
      <div style="text-align: center;">
        <div class="grid-well">
          <!-- ko component: {
              name: 'grid-cmp',
              params: {
                  reference: gridComponent,
                  rows: [
                      [1,2,3,4,5,2,3,4,5],
                      [2,4,1,3,5,2,3,4,5],
                      [1,2,3,4,5,2,3,4,5],
                      [5,2,4,1,3,2,3,4,5],
                      [1,2,3,4,5,2,3,4,5]
                  ],
                  cellType: 'image-cell-tmpl'
               }
          } --><!-- /ko -->
        </div>
      </div>
    </div>
    <script type="text/javascript">
      //Apply grid component bindings in an empty viewmodel context
      // All data is supplied in component parameters
      var engine = new EngineVM({


      });

      // Setup callback on frame advance
      engine.afterAdvance = function(eng) {

            var col = 0, row = 0, item = 0;
            var grid = engine.gridComponent();
            var maxCol = 0;
            var maxRow = 0;
            var gridData = grid.getGridData();
            maxRow = gridData.length;
            maxCol = gridData.length == 0 ? 0 : gridData[0].length;
            var maxTile = grid.tiles().length;
            for (var i = 0; i < 2; i++) {
                if (Math.random() > 0.2) {
                  col = Math.floor((Math.random() * maxCol));
                  row = Math.floor((Math.random() * maxRow));
                  item = Math.floor((Math.random() * (maxTile)) + 1);

                  grid.setCell(row, col, item);
                }
            }
        };

      // Configure Knockout options
      ko.options.deferUpdates = true; // Make all updates async for performance

      ko.applyBindings(engine, document.getElementById('sandbox'));

      engine.start();
    </script>
  </body>
</html>
